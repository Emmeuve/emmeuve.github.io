name: Update Behance Projects

on:
  schedule:
    # Ejecutar todos los dÃ­as a las 6 AM UTC (3 AM Chile)
    - cron: '0 6 * * *'
  workflow_dispatch: # Permitir ejecuciÃ³n manual desde GitHub
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-behance.yml'

# Permisos necesarios para el workflow
permissions:
  contents: write
  actions: read

jobs:
  update-behance:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm init -y
          npm install xml2js node-fetch@2
      
      - name: ðŸŽ¨ Fetch Behance Projects
        run: |
          node << 'EOF'
          const fetch = require('node-fetch');
          const xml2js = require('xml2js');
          const fs = require('fs');
          const path = require('path');
          
          const username = 'Emmeuve'; // Tu username de Behance
          const maxProjects = 12;
          
          (async () => {
            try {
              console.log('ðŸ” Fetching Behance RSS feed...');
              
              const response = await fetch(
                `https://www.behance.net/feeds/user?username=${username}`,
                {
                  headers: {
                    'User-Agent': 'Mozilla/5.0 (compatible; BehanceBot/1.0)'
                  }
                }
              );
              
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const xmlData = await response.text();
              console.log('âœ… RSS feed fetched successfully');
              
              const parser = new xml2js.Parser();
              const result = await parser.parseStringPromise(xmlData);
              
              if (!result.rss || !result.rss.channel || !result.rss.channel[0].item) {
                throw new Error('Invalid RSS structure');
              }
              
              const items = result.rss.channel[0].item;
              console.log(`ðŸ“Š Found ${items.length} projects`);
              
              const projects = items.slice(0, maxProjects).map((item, index) => {
                const content = item.description ? item.description[0] : '';
                
                // Extraer imagen - buscar la de mejor calidad
                let imageUrl = '';
                
                // Buscar todas las imÃ¡genes en el contenido
                const imgMatches = content.match(/<img[^>]+src="([^">]+)"/g);
                
                if (imgMatches && imgMatches.length > 0) {
                  // Extraer la primera imagen (suele ser la portada)
                  const firstImg = imgMatches[0].match(/src="([^">]+)"/);
                  if (firstImg) {
                    imageUrl = firstImg[1];
                    
                    // Intentar obtener versiÃ³n de mayor calidad
                    // Behance usa URLs como: /url/404.jpg o /url/original.jpg
                    imageUrl = imageUrl.replace('/404/', '/original/');
                    
                    // Si tiene parÃ¡metros de tamaÃ±o, usar imagen original
                    if (imageUrl.includes('?')) {
                      imageUrl = imageUrl.split('?')[0];
                    }
                  }
                }
                
                // Limpiar descripciÃ³n de HTML
                const cleanDesc = content
                  .replace(/<[^>]*>/g, '')
                  .replace(/&nbsp;/g, ' ')
                  .replace(/&amp;/g, '&')
                  .replace(/&quot;/g, '"')
                  .replace(/&apos;/g, "'")
                  .trim()
                  .substring(0, 150);
                
                return {
                  id: `behance-project-${index + 1}`,
                  title: item.title ? item.title[0] : 'Untitled Project',
                  link: item.link ? item.link[0] : '',
                  description: cleanDesc || 'Ver proyecto en Behance',
                  image: imageUrl,
                  pubDate: item.pubDate ? item.pubDate[0] : new Date().toISOString(),
                  source: 'behance'
                };
              });
              
              const data = {
                lastUpdate: new Date().toISOString(),
                username: username,
                totalProjects: projects.length,
                projects: projects
              };
              
              // Asegurar que el directorio existe
              const dataDir = path.join(process.cwd(), 'assets', 'data');
              if (!fs.existsSync(dataDir)) {
                fs.mkdirSync(dataDir, { recursive: true });
              }
              
              const filePath = path.join(dataDir, 'behance-projects.json');
              fs.writeFileSync(filePath, JSON.stringify(data, null, 2));
              
              console.log('âœ… Projects saved to:', filePath);
              console.log(`ðŸ“ Total projects saved: ${projects.length}`);
              console.log('ðŸŽ‰ Update completed successfully!');
              
            } catch (error) {
              console.error('âŒ Error:', error.message);
              console.error('Stack:', error.stack);
              process.exit(1);
            }
          })();
          EOF
      
      - name: ðŸ“¤ Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Agregar archivo
          git add assets/data/behance-projects.json
          
          # Verificar si hay cambios
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
            exit 0
          fi
          
          # Hacer commit
          git commit -m "ðŸ¤– Update Behance projects [automated]"
          
          # Intentar push con retry
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ðŸ“¤ Attempting push (attempt $attempt/$max_attempts)..."
            
            if git push origin main; then
              echo "âœ… Changes pushed successfully"
              exit 0
            fi
            
            echo "âš ï¸ Push failed, retrying in 5 seconds..."
            sleep 5
            attempt=$((attempt + 1))
          done
          
          echo "âŒ Failed to push after $max_attempts attempts"
          exit 1
      
      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "### ðŸŽ¨ Behance Projects Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Username:** Emmeuve" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          
          if [ -f assets/data/behance-projects.json ]; then
            PROJECTS_COUNT=$(cat assets/data/behance-projects.json | grep -o '"totalProjects":[0-9]*' | grep -o '[0-9]*' || echo "0")
            echo "- **Projects Found:** $PROJECTS_COUNT" >> $GITHUB_STEP_SUMMARY
          fi